<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Runner Game Test</title>
    <style>
      * { padding: 0; margin: 0; }
      canvas { background: #30dcff; display: block; margin: 0 auto; }
    </style>
  </head>
  <body>
    <canvas id="myCanvas" width="900" height="600"></canvas>

    <script>
      var canvas = document.getElementById("myCanvas");
      var ctx = canvas.getContext("2d");
      var tileSize = 25;
      var leftTile = 0;
      var maxLeftTile = 80 - (900/tileSize);

      var rightPressed = false;
      var leftPressed = false;
      var upPressed = false;
      var downPressed = false;
      var spacePressed = false;
      var jumping = false;

      var map = [
        [2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],
        [2,0,0,0,0,0,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,3,3,3,0,0,0,0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,3,3,3,3,3,3,0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0,0,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,2],
        [2,0,0,0,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,0,0,0,0,0,2],
        [2,0,3,3,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,3,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,3,3,3,3,3,3,3,3,3,0,0,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,3,3,3,0,0,0,2],
        [2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2],
        [2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2]
      ]; // this is 80 x 24

      var dudeX = 15;
      var dudeY = 21;
      var dudeColor = "red";

      var jumpHeight = 7;
      var jumpStart = null;

      var ghosts = [{x: 1, dx: 1, alive: true}, {x: 30, dx: 1, alive: true}];
      var ghostY = 21;
      var ghostColor = "blue";
      var ghostMove = 0;

      var maxLives = 5;
      var lives = maxLives;
      var gameOver = false;


      function draw() {
        var rowNum = -1;

        directionHandler();
        collisionChecker();

        ghostMove += 1;

        if (ghostMove === 8) {
          ghostHandler();
          ghostMove = 0;
        }

        map.forEach((row) => {
          rowNum += 1;
          var tileNum = -1;
          row.forEach((tile) => {
            tileNum += 1;
            if (tileNum === dudeX && rowNum === dudeY) {
              ctx.fillStyle = dudeColor;
            } else if (tile === 0) {
              ctx.fillStyle = "#30dcff";
            } else if (tile === 1){
              ctx.fillStyle = "green";
            } else if (tile === 2){
              ctx.fillStyle = "black";
            } else if (tile === 3){
              ctx.fillStyle = "brown";
            }

            if (rowNum === ghostY) {
              ghosts.forEach((ghost) => {
                if (ghost.x === tileNum && ghost.alive) {
                  ctx.fillStyle = ghostColor;
                }
              });
            }

            if (tileNum >= leftTile) {
              ctx.fillRect((tileNum*tileSize - leftTile*tileSize), rowNum * tileSize, tileSize, tileSize);
            }
          })
        })
        jumpHandler();
        //
        // if (lives > 0) {
        //   ctx.font = "30px serif";
        //   ctx.fillText(`Lives: ${lives}`, 40, 40);
        // } else {
        //   gameOver = true;
        //   setTimeout(restartGame, 5000);
        // }
        //
        // if (gameOver) {
        //   ctx.font = "60px serif";
        //   ctx.fillText(`GAME OVER`, 40, 60);
        // }
      }

      function heightAboveGround() {
        var hag = 0;
        yVar = dudeY + 1;
        for (let i = 0; i < 24; i ++) {
          if (map[yVar][dudeX] !== 0) {
            return hag;
          } else {
            yVar += 1;
            hag += 1;
          }
        }
      }

      function onGround() {
        return heightAboveGround() === 0;
      }

      function leftFree(x,y) {
        return map[y][x-1] === 0;
      }

      function rightFree(x,y) {
        return map[y][x+1] === 0;
      }

      function topFree() {
        return map[dudeY-1][dudeX] === 0;
      }

      function jumpHandler() {
        if(spacePressed && onGround()) {
          jumping = true;
          jumpStart = dudeY;
        }

        if(jumping && ((jumpStart - dudeY) < jumpHeight) && topFree()) {
          dudeY -= 1;
        } else if (jumping) {
          jumping = false;
          jumpStart = null;
        }

        if(!jumping && !onGround()) {
          dudeY += 1;
        }

      }

      function ghostHandler() {
        ghosts.forEach((ghost) => {
          if (ghost.dx === -1 && leftFree(ghost.x, 21)) {
            ghost.x -= 1;
          } else if (ghost.dx === 1 && rightFree(ghost.x, 21)) {
            ghost.x += 1;
          } else {
            ghost.dx = -ghost.dx;
          }
        })
      }

      function directionHandler() {
        if (leftPressed && leftFree(dudeX, dudeY) && (dudeX - leftTile > 15)) {
          dudeX -= 1;
        } else if (leftPressed && leftFree(dudeX,dudeY) && leftTile > 0) {
          leftTile -= 1;
          dudeX -= 1;
        } else if (leftPressed && leftFree(dudeX, dudeY)) {
          dudeX -= 1;
        }

        if (rightPressed && rightFree(dudeX, dudeY) && (dudeX - leftTile < 15)) {
          dudeX += 1;
        } else if (rightPressed && rightFree(dudeX,dudeY) && leftTile < maxLeftTile) {
          leftTile += 1;
          dudeX += 1;
        } else if (rightPressed && rightFree(dudeX, dudeY)) {
          dudeX += 1;
        }

      }

      function collisionChecker() {
        ghosts.forEach((ghost) => {
          if (ghost.alive && ghost.x === dudeX && ghostY === dudeY) {
            lives -= 1;
          } else if (ghost.x === dudeX && ghostY - 1 === dudeY) {
            ghost.alive = false;
          }
        })
      }

      function keyDownHandler(e) {
        if(e.keyCode == 39) {
          rightPressed = true;
        }
        else if(e.keyCode == 37) {
          leftPressed = true;
        }
        else if(e.keyCode == 38) {
          upPressed = true;
        }
        else if(e.keyCode == 40) {
          downPressed = true;
        }
        else if(e.keyCode == 32) {
          spacePressed = true;
        }
      }

      function keyUpHandler(e) {
        if(e.keyCode == 39) {
          rightPressed = false;
        }
        else if(e.keyCode == 37) {
          leftPressed = false;
        }
        else if(e.keyCode == 38) {
          upPressed = false;
        }
        else if(e.keyCode == 40) {
          downPressed = false;
        }
        else if(e.keyCode == 32) {
          spacePressed = false;
        }
      }

      document.addEventListener("keydown", keyDownHandler, false);
      document.addEventListener("keyup", keyUpHandler, false);
      setInterval(draw, 30);
    </script>
  </body>
</html>
