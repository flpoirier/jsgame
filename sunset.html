<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Sunset</title>
    <style>
      * { padding: 0; margin: 0; }
      canvas { display: block; margin: 0 auto; }
    </style>
  </head>
  <body>
    <canvas id="myCanvas" width="1100" height="750"></canvas>
    <script>
      var canvas = document.getElementById("myCanvas");
      var ctx = canvas.getContext("2d");
      var canvasWidth = 1100;
      var canvasHeight = 750;

      var sunRad = 20;
      var sunX = canvasWidth / 2;
      var sunY = sunRad;
      var sunset = 0;

      var asteroidColors = ["red", "orange", "yellow", "green", "blue", "purple"];
      var asteroidSpeed = 20;
      var asteroidRad = 10;
      var asteroidPush = 60;
      var asteroids = [];

      function asteroidConstructor() {
        if (sunY < canvasHeight) {
          let asteroidX = getRandomInt(0, canvasWidth);
          let asteroidY = -1 * asteroidRad;
          // let asteroidCol = asteroidColors[getRandomInt(0, asteroidColors.length)];
          let asteroidCol = "#292e37";
          let asteroidCollisionPoint = bridgeCollisionPoint(asteroidX);
          let asteroidFalling = true;
          let asteroidRolling = false;
          asteroids.push({X: asteroidX, Y: asteroidY, color: asteroidCol,
            collisionPoint: asteroidCollisionPoint, falling: asteroidFalling, rolling: asteroidRolling});
        }
      }

      var bridgeX = canvasWidth / 2;
      var bridgeY = canvasHeight + 400;
      var bridgeRad = canvasWidth * 2/3;
      var bridgeHeight = Math.floor(bridgeRad + asteroidRad);

      var stars = [];
      var numStars = 800;
      var twinkle = 0;
      var starsOut = 0;

      for (let star = 0; star < numStars; star++) {
        let starX = getRandomInt(0, canvasWidth);
        let starY = getRandomInt(-canvasHeight, canvasHeight);
        let starRad = getRandomInt(1,3);
        stars.push({starX: starX, starY: starY, starRad: starRad});
      }

      var red = 85;
      var green = 200;
      var blue = 255;

      var maxTime = 30;
      var time = maxTime;
      var minsAndSecs;
      timeString();

      var gameOver = false;
      var gameWon = false;
      var gameLost = false;
      var endMargin = 40;
      var endPoint = canvasWidth - endMargin;

      var dudeX = endMargin;
      var dudeY;
      var dudeHeight = 75;
      var dudeDx = 1;
      var walkSpeed = 2;

      var rightPressed = false;
      var leftPressed = false;
      var upPressed = false;
      var downPressed = false;
      var spacePressed = false;

      var jumping = false;
      var jumpHeight = 0;
      var jumpSpeed = 3;
      var maxJump = 80;

      function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min)) + min;
      }

      function distance(x1, y1, x2, y2) {
        return Math.sqrt( (x1-x2)*(x1-x2) + (y1-y2)*(y1-y2) );
      }

      function bridgeCollisionPoint(astX) {
        return -1 * Math.floor(Math.sqrt( (bridgeHeight*bridgeHeight) - ((astX-bridgeX)*(astX-bridgeX)) ) - bridgeY);
      }

      function skyColored(r, g) {
        let redDiff = Math.abs(red - r);
        let greenDiff = Math.abs(green - g);
        if (redDiff === 0 && greenDiff === 0) {
          return true;
        } else {
          return false;
        }
      }

      function collisionChecker() {
        asteroids.forEach((asteroid) => {
          if ((Math.floor(distance(asteroid.X, asteroid.Y, dudeX, dudeY)) + 2) < asteroidRad) {
            dudeX -= asteroidPush;
          }
        });
      }

      function draw() {

        sunset += 1;

        if (sunset === 8 && blue > 40) {
          red -= 1;
          green -= 2;
          blue -= 2;
          sunset = 0;
        }

        if (sunY < canvasHeight) {
          sunY += 1;
        } else {
          sunY += 2;
        }

        ctx.fillStyle = `rgb(${red},${green},${blue})`;
        ctx.fillRect(0,0,canvasWidth,canvasHeight);


        if (blue < 150) {

          twinkle += 1;
          // this will break unless numStars is even!!!
          if (starsOut < numStars) {
            starsOut += 2;
          }

          if (twinkle === 3) {
            let idx = getRandomInt(0,stars.length);
            let star = stars[idx];
            if (star.starRad === 0) {
              star.starRad = 1;
            } else if (star.starRad === 1) {
              star.starRad = getRandomInt(0,3);
            } else if (star.starRad === 2) {
              star.starRad = 1;
            }
            twinkle = 0;
          }

          for (let starIdx = 0; starIdx < starsOut; starIdx ++) {
            let star = stars[starIdx];
            ctx.fillStyle = "white";
            ctx.beginPath();
            ctx.arc(star.starX, star.starY, star.starRad, 0, 2 * Math.PI);
            ctx.fill();
          }
        }

        let dist = 450;
        let tempRed = 255;
        let tempGreen = 255;
        let trans = 0.03;

        while (dist >= 0) {

          tempRed = red - dist + Math.floor(300*sunY/500);
          if (tempRed < red) {
            tempRed = red;
          }

          tempGreen = green - dist + Math.floor(175*sunY/500);
          if (tempGreen < green) {
            tempGreen = green;
          }

          if (!skyColored(tempRed, tempGreen)) {
            ctx.fillStyle = `rgba(${tempRed},${tempGreen},${blue}, ${trans})`;
            ctx.beginPath();
            ctx.arc(sunX, sunY, dist, 0, 2 * Math.PI);
            ctx.fill();
          }

          dist -= 3;
          if (trans < 1) {
            trans += 0.03;
          }
        }

        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(sunX, sunY, sunRad, 0, 2 * Math.PI);
        ctx.fill();


        ctx.strokeStyle = "#7b9095";
        ctx.lineWidth = 15;
        ctx.beginPath();
        ctx.arc(bridgeX, bridgeY, bridgeRad, Math.PI, 2 * Math.PI)
        ctx.stroke();

        let translatedDudeX = 0;
        if (dudeX < bridgeX) {
          translatedDudeX = -(bridgeX - dudeX);
        } else if (dudeX > bridgeX) {
          translatedDudeX = dudeX - bridgeX;
        }

        let dudeAngle = Math.PI - Math.acos(translatedDudeX / bridgeRad);
        let dudeXDraw = dudeX;

        // change dudeX to account for jump

        // if (dudeX > Math.floor(canvasWidth / 2)) {
        //   dudeXDraw += jumpHeight;
        // } else if (dudeX < Math.floor(canvasWidth / 2)) {
        //   dudeXDraw -= jumpHeight;
        // }

        dudeY = bridgeY - Math.floor(bridgeRad * Math.sin(dudeAngle)) - jumpHeight - 8;

        ctx.strokeStyle = "purple";
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(dudeX, dudeY);
        ctx.lineTo(dudeX - dudeHeight * Math.cos(dudeAngle), dudeY - dudeHeight * Math.sin(dudeAngle));
        ctx.stroke();


        asteroids.forEach((asteroid) => {

          ctx.fillStyle = asteroid.color;
          ctx.beginPath();
          ctx.arc(asteroid.X, asteroid.Y, asteroidRad, 0, 2 * Math.PI);
          ctx.fill();

          if (asteroid.Y >= (asteroid.collisionPoint - asteroidSpeed)) {
            asteroid.falling = false;
            asteroid.Y = asteroid.collisionPoint;
            asteroid.rolling = true;
          }

          if (asteroid.falling) {

            asteroid.Y += asteroidSpeed;

          } else if (asteroid.rolling) {

            asteroid.X -= Math.floor(asteroidSpeed / 2);

            let translatedAstX = 0;
            if (asteroid.X < bridgeX) {
              translatedAstX = -(bridgeX - asteroid.X);
            } else if (asteroid.X > bridgeX) {
              translatedAstX = asteroid.X - bridgeX;
            }

            let asteroidAngle = Math.PI - Math.acos(translatedAstX / bridgeRad);
            asteroid.Y = bridgeY - Math.floor(bridgeRad * Math.sin(asteroidAngle)) - 10;

          }

        });

        collisionChecker();


        // if (asteroidY > canvasHeight + asteroidRad) {
        //   asteroidX = getRandomInt(0, canvasWidth);
        //   asteroidY = -asteroidRad;
        //   asteroidCol = asteroidColors[getRandomInt(0, asteroidColors.length)];
        // }


        ctx.fillStyle = "white";
        ctx.font = "30px sans-serif";
        ctx.fillText(`${minsAndSecs}`, 40, 60);

        if (gameWon) {
          ctx.fillStyle = "white";
          ctx.font = "60px sans-serif";
          ctx.fillText("You won!", (canvasWidth / 2) - 125, canvasHeight / 2);
        } else if (gameLost) {
          ctx.fillStyle = "white";
          ctx.font = "60px sans-serif";
          ctx.fillText("You lost!", (canvasWidth / 2) - 125, canvasHeight / 2);
        }


        // walking logic

        if (leftPressed) {
          dudeX -= walkSpeed;
        } else if (rightPressed) {
          dudeX += walkSpeed;
        }

        // boundaries on where avatar can walk

        if (dudeX >= endPoint && time > 0) {
          dudeX = endPoint;
          gameOver = true;
          gameWon = true;
        } else if (dudeX >= endPoint) {
          dudeX = endMargin;
        } else if (dudeX < endMargin) {
          dudeX = endMargin;
        }

        if (time === 0 && !gameWon) {
          gameOver = true;
          gameLost = true;
        }

        // jumping logic

        if (spacePressed) {
          jumping = true;
        }

        // if (jumping && jumpHeight < maxJump) {
        //   jumpHeight += jumpSpeed;
        // } else if (jumping && jumpHeight === maxJump) {
        //   jumping = false;
        // } else if (!jumping && jumpHeight > 0) {
        //   jumpHeight -= 2 * jumpSpeed;
        // }

        // jump height proportional to length of time space bar pressed

        if (spacePressed && jumpHeight < maxJump) {
          jumpHeight += jumpSpeed;
        } else if (!spacePressed && jumpHeight > 0) {
          jumpHeight -= 2 * jumpSpeed;
        }

      }

      // end of draw function

      function keyDownHandler(e) {
        if(e.keyCode == 39) {
          rightPressed = true;
        }
        else if(e.keyCode == 37) {
          leftPressed = true;
        }
        else if(e.keyCode == 38) {
          upPressed = true;
        }
        else if(e.keyCode == 40) {
          downPressed = true;
        }
        else if(e.keyCode == 32) {
          spacePressed = true;
        }
      }

      function keyUpHandler(e) {
        if(e.keyCode == 39) {
          rightPressed = false;
        }
        else if(e.keyCode == 37) {
          leftPressed = false;
        }
        else if(e.keyCode == 38) {
          upPressed = false;
        }
        else if(e.keyCode == 40) {
          downPressed = false;
        }
        else if(e.keyCode == 32) {
          spacePressed = false;
        }
      }

      function timeTick() {
        if (time > 0) {
          time -= 1;
        }
        timeString();
      }

      function timeString() {
        let mins = Math.floor(time / 60);
        let secs = time - (mins * 60);
        if (mins === 0) {
          mins = "00";
        } else {
          mins = `0${mins}`;
        }
        if (secs === 0) {
          secs = "00";
        } else if (secs < 10) {
          secs = `0${secs}`;
        } else if (secs > 10) {
          secs = `${secs}`;
        }
        minsAndSecs = `${mins}:${secs}`;
      }

      document.addEventListener("keydown", keyDownHandler, false);
      document.addEventListener("keyup", keyUpHandler, false);

      setInterval(draw, 30);
      setInterval(timeTick, 1000);
      setInterval(timeString, 1000);
      setInterval(asteroidConstructor, 1000);
      setInterval(asteroidConstructor, 2500);

    </script>
  </body>
</html>
